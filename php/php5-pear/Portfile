# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                php5-pear
version             20110334
categories          php www
platforms           darwin
maintainers         pixilla
description         PEAR build and repository support for php5
long_description    ${description}
homepage            http://pear.php.net
master_sites        http://pear.php.net
livecheck.type      moddate

depends_lib         port:php5

dist_subdir         ${name}-${version}
distfiles           install-pear-nozlib.phar

checksums           sha1    d59ea92ebd9bea4c992026f4473a3249779231fd \
                    rmd160  cd70e616f81f0c3450904b70f00a117879f0abc3

extract.mkdir       yes
set buildpath ${worksrcpath}/build
extract {
    xinstall -d ${buildpath}/libexec/php/pear/bin
    xinstall -d ${buildpath}/libexec/php/pear/etc
    xinstall -d ${buildpath}/lib/php/pear
    xinstall -d ${buildpath}/var/db/php5
    file copy ${distpath}/install-pear-nozlib.phar ${worksrcpath}
}
use_configure       no
build {
    system "cd ${worksrcpath} && ${prefix}/bin/php install-pear-nozlib.phar -d ${buildpath}/libexec/php/pear -b ${buildpath}/libexec/php/bin -c ${buildpath}/libexec/php/etc"
    system "cd ${worksrcpath} && PHP_PEAR_INSTALL_DIR=${buildpath}/libexec/php/pear PHP_PEAR_BIN_DIR=${buildpath}/libexec/php/bin ${buildpath}/libexec/php/bin/pear -c ${buildpath}/libexec/php/etc/pear.conf -C ${buildpath}/libexec/php/etc/pear.conf config-set bin_dir ${prefix}/libexec/php/pear/bin"
    system "cd ${worksrcpath} && PHP_PEAR_INSTALL_DIR=${buildpath}/libexec/php/pear PHP_PEAR_BIN_DIR=${buildpath}/libexec/php/bin ${buildpath}/libexec/php/bin/pear -c ${buildpath}/libexec/php/etc/pear.conf -C ${buildpath}/libexec/php/etc/pear.conf config-set php_dir ${prefix}/lib/php/pear"
    system "cd ${worksrcpath} && PHP_PEAR_INSTALL_DIR=${buildpath}/libexec/php/pear PHP_PEAR_BIN_DIR=${buildpath}/libexec/php/bin ${buildpath}/libexec/php/bin/pear -c ${buildpath}/libexec/php/etc/pear.conf -C ${buildpath}/libexec/php/etc/pear.conf config-set php_bin ${prefix}/bin/php"
    system "cd ${worksrcpath} && PHP_PEAR_INSTALL_DIR=${buildpath}/libexec/php/pear PHP_PEAR_BIN_DIR=${buildpath}/libexec/php/bin ${buildpath}/libexec/php/bin/pear -c ${buildpath}/libexec/php/etc/pear.conf -C ${buildpath}/libexec/php/etc/pear.conf config-show"
    set fp [open ${buildpath}/lib/php/pear/pear-ini.php w]
    puts $fp "<?php"
    puts $fp "# Automatically add the PEAR repository path to PHP's include_path."
    puts $fp "set_include_path ( get_include_path (  ) . PATH_SEPARATOR . '${prefix}/lib/php/pear' ) ;"
    puts $fp "?>"
    close $fp
    set fp [open ${buildpath}/var/db/php5/pear.ini w]
    puts $fp "; Do not edit this file; it is automatically generated by MacPorts."
    puts $fp "; Any changes you make will be lost if you upgrade or uninstall php5-pear."
    puts $fp "; To configure PHP, edit ${prefix}/etc/php5/php.ini."
    puts $fp "auto_prepend_file = '${prefix}/lib/php/pear/pear-ini.php'"
    close $fp
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/bin/pear
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/bin/peardev
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/bin/pecl
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/pear/pearcmd.php
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/pear/peclcmd.php
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/pear/.registry/archive_tar.reg
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/pear/.registry/console_getopt.reg
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/pear/.registry/pear.reg
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/pear/.registry/structures_graph.reg
    reinplace "s|${buildpath}|${prefix}|g" ${buildpath}/libexec/php/pear/.registry/xml_util.reg
}

destroot {
    xinstall -d ${destroot}${prefix}/lib/php/pear
    xinstall -d ${destroot}${prefix}/var/db/php5
    file copy ${buildpath}/lib/php/pear/pear-ini.php ${destroot}${prefix}/lib/php/pear/pear-ini.php
    file copy ${buildpath}/var/db/php5/pear.ini ${destroot}${prefix}/var/db/php5/pear.ini
    file copy ${buildpath}/libexec/php ${destroot}${prefix}/libexec
}