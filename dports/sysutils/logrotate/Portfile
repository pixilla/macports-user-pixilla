# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                logrotate
version             3.8.0
categories          sysutils
maintainers         markd openmaintainer
platforms           darwin

description         Rotates, compresses, and mails system logs

long_description    The logrotate utility is designed to simplify the administration of log files \
                    on a system which generates a lot of log files. Logrotate allows for the \
                    automatic rotation compression, removal and mailing of log files. Logrotate \
                    can be set to handle a log file \daily, weekly, monthly or when the log file \
                    gets to a certain size.

homepage            https://fedorahosted.org/logrotate/
master_sites        gentoo
checksums           sha1    a79c500c4ce45177b47bb473a6bff4021af7121e \
                    rmd160  7e1e24f53db5230eee2e1db8d90fe3a33692ca01

patch.pre_args      -p1
patchfiles          patch-config.c.diff \
                    patch-Makefile.diff

depends_run         port:popt port:gettext port:gzip

post-extract {
    touch ${worksrcpath}/.depend
}

post-patch {
    reinplace "s|@@PREFIX@@|${prefix}|g" \
        ${worksrcpath}/examples/logrotate-default
}

use_configure       no

build.env-append    CC="${configure.cc} [get_canonical_archflags]" \
                    CXX="${configure.cxx} [get_canonical_archflags]" \
                    CPP="${configure.cpp} [get_canonical_archflags]" \
                    BASEDIR="${prefix}" \
                    POPT_DIR="${prefix}/include" \
                    STATEFILE="${prefix}/var/run/logrotate/logrotate.status" \
                    DEFAULT_MAIL_COMMAND="/usr/sbin/mail"

destroot.args       INSTALL="install" \
                    BASEDIR=[string trimleft ${destroot}${prefix} /] \
                    MANDIR="${prefix}/share/man"
destroot.keepdirs   ${destroot}${prefix}/etc/logrotate.d \
                    ${destroot}${prefix}/var/run/logrotate
post-destroot {
    xinstall -m 755 ${worksrcpath}/examples/logrotate-default \
        ${destroot}${prefix}/etc/logrotate.conf.sample
}

variant bzip2 conflicts gzip description {Use bzip2 compression by default} {
    build.env-append \
                    COMPRESS_COMMAND="${prefix}/bin/bzip2" \
                    COMPRESS_EXT=".bz2" \
                    UNCOMPRESS_COMMAND="${prefix}/bin/bunzip2"
    depends_run-append \
                    port:bzip2
}

variant gzip conflicts bzip2 description {Use gzip compression by default} {
    build.pre_args-append \
                    COMPRESS_COMMAND="${prefix}/bin/gzip" \
                    COMPRESS_EXT=".gz" \
                    UNCOMPRESS_COMMAND="${prefix}/bin/gunzip"
    depends_run-append \
                    port:gzip
}

if {![variant_isset gzip]} {
    default_variants +bzip2
    variant_set bzip2
}

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     ${name}-(\\d+\\.\\d+(\\.\\d+)?)${extract.suffix}

notes \
"Copy ${prefix}/etc/logrotate.conf.sample to ${prefix}/etc/logrotate.conf for a start:
\$ cp ${prefix}/etc/logrotate.conf.sample ${prefix}/etc/logrotate.conf
Afterwards putting logrotate scripts in ${prefix}/etc/logrotate.d will cause them to 
be executed with the following command:
\$ ${prefix}/bin/${name} ${prefix}/etc/logrotate.conf"
