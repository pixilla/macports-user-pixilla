# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0

name                    mysql55-server
version                 5.5.19
set branch              [join [lrange [split ${version} .] 0 1] .]
set branch_name         [join [lrange [split ${version} .] 0 1] ""]
categories              databases
platforms               darwin
maintainers             pixilla openmaintainer
license                 GPL-2
description             Multithreaded SQL database server
long_description        MySQL is an open-source, multi-threaded SQL database with a command \
                        syntax very similar to mSQL.

homepage                http://www.mysql.com/
distfiles

depends_run             port:mysql55

set mysql               mysql${branch_name}
set libdir              ${prefix}/lib/${mysql}
set bindir              ${libdir}/bin
set dbdir               ${prefix}/var/db/${mysql}
set sysconfdir          ${prefix}/etc/${mysql}

if {"darwin" == ${os.platform} && ${os.major} > 8} {
    set mysqluser       _mysql
} else {
    set mysqluser       mysql
}

add_users               ${mysqluser} group=${mysqluser} realname=MySQL\ Server
startupitem.create      yes
startupitem.name        ${mysql}
startupitem.start       "${prefix}/share/${mysql}/mysql/mysql.server start"
startupitem.stop        "${prefix}/share/${mysql}/mysql/mysql.server stop"

use_configure           no
supported_archs         noarch

build {}

destroot {
    xinstall -m 755 -o root -d ${destroot}${prefix}/var/run
    xinstall -m 755 -o ${mysqluser} -g ${mysqluser} -d \
        ${destroot}${dbdir} \
        ${destroot}${prefix}/var/log/${mysql} \
        ${destroot}${prefix}/var/run/${mysql}
    destroot.keepdirs-append  \
        ${destroot}${dbdir} \
        ${destroot}${prefix}/var/log/${mysql} \
        ${destroot}${prefix}/var/run/${mysql}
}

notes "

If this is a new install you might want to run:
    \$ sudo -u ${mysqluser} mysql_install_db5

"

livecheck.type          regex
livecheck.version       [lindex [split ${version} -] 0]
livecheck.url           http://dev.mysql.com/
livecheck.regex         "<a href=\"http://dev.mysql.com/downloads/mysql/\[^\"\]+\">(${branch}(\.\[0-9.\]+)?)\[^<\]*</a>"
