# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

set version_mysql   5
set name_package    lib_mysqludf_json
name                mysql${version_mysql}-${name_package}
version             0.0.2
distname            ${name_package}_${version}
categories          databases lang
maintainers         pixilla
platforms           darwin
license             LGPL

description         Map database data to the JSON.
long_description    ${description}

homepage            http://www.mysqludf.org/${name_package}/
master_sites        ${homepage}

checksums           sha1    e839c563449d1c1b54ddfc05277500824f287d0c \
                    rmd160  4c98739ed2753580195e11e602777188bc9a20ff

depends_lib-append  path:${prefix}/lib/mysql${version_mysql}/bin/mysql_config:mysql${version_mysql}

extract.mkdir       yes

use_configure       no

configure.cppflags-append \
                    -I${prefix}/include/mysql5/mysql \
                    -bundle \
                    -undefined dynamic_lookup


post-extract {
    move ${worksrcpath}/${name_package}.so \
            ${worksrcpath}/${name_package}.so.orig
}

build {
    set cmd "${configure.cc} ${configure.ldflags} ${configure.cflags} ${configure.cppflags}"
    system "cd ${worksrcpath} && ${cmd} ${name_package}.c -o ${name_package}.so"

    xinstall -d ${worksrcpath}/macports
    set fp [open ${worksrcpath}/macports/installdb.sql w]
    puts $fp "USE mysql;"
    puts $fp "DROP FUNCTION IF EXISTS lib_mysqludf_json_info;"
    puts $fp "DROP FUNCTION IF EXISTS json_array;"
    puts $fp "DROP FUNCTION IF EXISTS json_members;"
    puts $fp "DROP FUNCTION IF EXISTS json_object;"
    puts $fp "DROP FUNCTION IF EXISTS json_values;"
    puts $fp "CREATE FUNCTION lib_mysqludf_json_info RETURNS STRING SONAME '${name_package}.so';"
    puts $fp "CREATE FUNCTION json_array RETURNS REAL SONAME '${name_package}.so';"
    puts $fp "CREATE FUNCTION json_members RETURNS REAL SONAME '${name_package}.so';"
    puts $fp "CREATE FUNCTION json_object RETURNS REAL SONAME '${name_package}.so';"
    puts $fp "CREATE FUNCTION json_values RETURNS REAL SONAME '${name_package}.so';"
    close $fp

    set fp [open ${worksrcpath}/macports/uninstalldb.sql w]
    puts $fp "USE mysql;"
    puts $fp "DROP FUNCTION IF EXISTS lib_mysqludf_json_info;"
    puts $fp "DROP FUNCTION IF EXISTS json_array;"
    puts $fp "DROP FUNCTION IF EXISTS json_members;"
    puts $fp "DROP FUNCTION IF EXISTS json_object;"
    puts $fp "DROP FUNCTION IF EXISTS json_values;"
    close $fp
}

destroot {
    xinstall -m 755 -d ${destroot}${prefix}/lib/mysql5/mysql/plugin
    xinstall -m 644 -W ${worksrcpath} ${name_package}.so \
        ${destroot}${prefix}/lib/mysql5/mysql/plugin
    xinstall -m 755 -d ${destroot}${prefix}/share/mysql${version_mysql}/${name_package}
    xinstall -m 644 -W ${worksrcpath}/macports installdb.sql uninstalldb.sql \
        ${destroot}${prefix}/share/mysql${version_mysql}/${name_package}
    xinstall -m 755 -d ${destroot}${prefix}/share/mysql${version_mysql}/${name_package}/doc/html
    xinstall -m 644 ${worksrcpath}/${name_package}.html \
        ${destroot}${prefix}/share/mysql${version_mysql}/${name_package}/doc/html/index.html
}

livecheck.url       ${master_sites}
livecheck.type      regex
livecheck.regex     "${name_package}-(\\d+\\.\\d+(\[\\drc.\]+)?)${extract.suffix}"

notes "

    This port installs two mysql scripts to simplify the install/uninstall of the ${name_package}
    UDFs (user-defined-functions) along with html documentation describing the functions syntax.
    
    Install:
    \$ ${prefix}/bin/mysql${version_mysql} -uroot -p < ${prefix}/share/mysql${version_mysql}/${name_package}/installdb.sql

    Uninstall:
    \$ ${prefix}/bin/mysql${version_mysql} -uroot -p < ${prefix}/share/mysql${version_mysql}/${name_package}/uninstalldb.sql
    
    HTML Documentation:
    $ open ${prefix}/share/mysql${version_mysql}/${name_package}/doc/html/index.html
    "
    
